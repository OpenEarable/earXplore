<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>earXplore - Earable Interaction Database</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/ui-range@1.1.2/dist/ui-range.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function () {

            let isUpdatingCheckboxes = false;

            const parentheticalColumns = [
            'Interaction_PANEL_Accuracy of Interaction Recognition', 
            'Interaction_PANEL_Robustness of Interaction Detection', 
            'Study_PANEL_Elicitation Study', 
            'Study_PANEL_Usability Evaluations', 
            'Study_PANEL_Cognitive Ease Evaluations', 
            'Study_PANEL_Discreetness of Interactions Evaluations', 
            'Study_PANEL_Social Acceptability of Interactions Evaluations', 
            'Study_PANEL_Accuracy of Interactions Evaluations', 
            'Study_PANEL_Alternative Interaction Validity Evaluations'
        ];
            
    // Hide ID column (2nd column) and columns from 8 onwards initially
    $('table thead th:nth-child(2), table tbody td:nth-child(2), table thead th:nth-child(n+8), table tbody td:nth-child(n+8)').hide();

            // Populate column toggle menu
            let columns = [];
            $('table thead th').each(function (index) {
                if (index > 0) { // Skip the first column
                    let colName = $(this).data('col').split('_').pop(); // Removes prefixes, keeping only the last part
                    let fullColName = $(this).data('col');
                    
                    // Skip the Abstract column
                    if (colName !== 'Abstract') {
                        columns.push(`<div class="form-check">
                                    <input class="form-check-input column-toggle" type="checkbox" data-index="${index + 1}" ${(index !== 1 && index < 7) ? 'checked' : ''}>
                                    <label class="form-check-label">${colName}</label>
                                </div>`);
                    } else {
                        // Hide Abstract column immediately
                        $(`table thead th:nth-child(${index + 1}), table tbody td:nth-child(${index + 1})`).hide();
                    }
                }
            });

            $('#columnToggles').html(columns.join(''));

        // Find the column toggle change event handler (around line 42)
        $('.column-toggle').on('change', function () {
            let colIndex = $(this).data('index');
            let isChecked = $(this).is(':checked');
            $(`table thead th:nth-child(${colIndex}), table tbody td:nth-child(${colIndex})`).toggle(isChecked);

            // Cache the checked columns selection
            const $checkedColumns = $('.column-toggle:checked');
            
            // Check if all columns are deselected
            if ($checkedColumns.length === 0) {
                $('table').hide();
            } else {
                $('table').show();
            }

            // Update filteredData and regenerate bar charts
            applyFilters();

            // Use the cached selection instead of querying again
            let selectedColumns = $checkedColumns.map(function () {
                return $(this).closest('.form-check').find('label').text();
            }).get();

        });

            // Toggle Menu Select All columns
            $('#toggleSelectAllColumns').on('click', function () {
                const $columnToggles = $('.column-toggle');
                $columnToggles.prop('checked', true);
                
                // Batch DOM updates
                const columns = [];
                $columnToggles.each(function () {
                    columns.push($(this).data('index'));
                });
                
                // Single DOM update for all columns
                const selectors = columns.map(idx => `table thead th:nth-child(${idx}), table tbody td:nth-child(${idx})`).join(', ');
                $(selectors).show();
                
                $('table').show();
                applyFilters();
            });

            // Toggle Menu Deselect All columns
            $('#toggleDeselectAllColumns').on('click', function () {
                const $columnToggles = $('.column-toggle');
                $columnToggles.prop('checked', false);
                
                // Batch DOM updates
                const columns = [];
                $columnToggles.each(function () {
                    columns.push($(this).data('index'));
                });
                
                // Single DOM update for all columns
                const selectors = columns.map(idx => `table thead th:nth-child(${idx}), table tbody td:nth-child(${idx})`).join(', ');
                $(selectors).hide();
                
                $('table').hide();
                applyFilters();
            });

            // Select All functionality for specific columns
            $('.select-all').on('click', function () {
                let colName = $(this).data('col');
                isUpdatingCheckboxes = true;
                $(`.filter-group[data-col="${colName}"] input[type=checkbox]`).prop('checked', true);
                isUpdatingCheckboxes = false;
                applyFilters();
            });

            $('.deselect-all').on('click', function () {
                let colName = $(this).data('col');
                isUpdatingCheckboxes = true;
                $(`.filter-group[data-col="${colName}"] input[type=checkbox]`).prop('checked', false);
                isUpdatingCheckboxes = false;
                applyFilters();
            });

            // Modified panel-wide select/deselect
            $('.select-all-panel').on('click', function () {
                let panelName = $(this).data('panel');
                isUpdatingCheckboxes = true;
                $(`.panel:has(h3:contains("${panelName}")) .filter-group input[type=checkbox]`).prop('checked', true);
                isUpdatingCheckboxes = false;
                applyFilters();
            });

            $('.deselect-all-panel').on('click', function () {
                let panelName = $(this).data('panel');
                isUpdatingCheckboxes = true; 
                $(`.panel:has(h3:contains("${panelName}")) .filter-group input[type=checkbox]`).prop('checked', false);
                isUpdatingCheckboxes = false;
                applyFilters();
            });

            // Initialize noUiSlider for range sliders
            $('.range-slider').each(function () {
                let slider = this;
                let min = parseInt($(slider).data('min'));
                let max = parseInt($(slider).data('max'));

                noUiSlider.create(slider, {
                    start: [min, max],
                    connect: true,
                    range: {
                        'min': min,
                        'max': max
                    },
                    tooltips: [true, true],
                    format: {
                        to: function (value) {
                            return Math.round(value);
                        },
                        from: function (value) {
                            return Number(value);
                        }
                    }
                });

                slider.noUiSlider.on('update', function (values, handle) {
                    let minValue = Math.round(values[0]);
                    let maxValue = Math.round(values[1]);
                    $(slider).closest('.filter-group').find('.range-min').text(minValue);
                    $(slider).closest('.filter-group').find('.range-max').text(maxValue);
                });

                slider.noUiSlider.on('change', applyFilters);
            });

            // Filtering logic
            $('.filter-group input[type=checkbox]').prop('checked', true);
            $('.filter-group input[type=range]').each(function () {
                $(this).val($(this).attr('max'));
            });

            // Exclusive Filtering state
            let exclusiveFiltering = {};

            // Toggle Exclusive Filtering
            $('.exclusive-filter').on('click', function () {
                let colName = $(this).data('col');
                exclusiveFiltering[colName] = !exclusiveFiltering[colName];
                $(this).text(`Exclusive Filtering (${exclusiveFiltering[colName] ? 'Activated' : 'Deactivated'})`);
                applyFilters();
            });

            // Update the event listener for info icons
            $('table').on('click', '.bi-info-circle', function () {
                const studyId = $(this).closest('tr').find('td:nth-child(2)').text().trim();
                showStudyDetails(studyId);
            });
            
            // Function to show study details modal
            function showStudyDetails(studyId) {
                // Find the row with the corresponding studyId
                const row = $(`table tbody tr td:nth-child(2):contains('${studyId}')`).closest('tr');
                if (!row.length) return;
                
                let rowData = {};
                let studyLink = '';
                
                row.find('td').each(function (index) {
                    let colName = $('table thead th').eq(index).data('col');
                    if (colName) {
                        rowData[colName] = $(this).text().trim();
                        
                        // Extract study link if present
                        if (colName === 'Study Link') {
                            studyLink = $(this).text().trim();
                        }
                    }
                });

                delete rowData.INFO; // Remove the INFO column
                
                // Update the study link button
                const $studyLinkButton = $('#studyLinkButton');
                
                if (studyLink && studyLink !== 'N/A' && studyLink.toLowerCase() !== 'nan') {
                    $studyLinkButton.attr('href', studyLink);
                    $studyLinkButton.removeClass('disabled');
                    $studyLinkButton.show();
                } else {
                    $studyLinkButton.attr('href', '#');
                    $studyLinkButton.addClass('disabled');
                    $studyLinkButton.hide(); // Hide the button if no link is available
                }
                
                // Use document fragment for efficient DOM manipulation
                const fragment = document.createDocumentFragment();
                const nav = document.createElement('nav');
                
                // Add headings and sections
                let currentSection = 'General Information';
                const addSectionHeading = (title) => {
                    const heading = document.createElement('h5');
                    heading.textContent = title;
                    nav.appendChild(heading);
                    currentSection = title;
                };
                
                // Add initial heading
                addSectionHeading('General Information');
                
                // Process all columns
                let colIndex = 0;
                for (const colName in rowData) {
                    // Skip displaying the Study Link in the details as we're using it for the button
                    if (colName === 'Study Link') continue;
                    
                    // Add section headings at appropriate positions
                    if (colIndex === 6) addSectionHeading('Sensors');
                    else if (colIndex === 8) addSectionHeading('Interaction');
                    else if (colIndex === 18) addSectionHeading('Study');
                    else if (colIndex === 26) addSectionHeading('Device');
                    else if (colIndex === 31) addSectionHeading('Applications');
                    else if (colIndex === 32) addSectionHeading('Study Summary');
                    
                    // Create the row element
                    const rowDiv = document.createElement('div');
                    const strong = document.createElement('strong');
                    strong.textContent = colName.split('_').pop() + ': ';
                    rowDiv.appendChild(strong);
                    rowDiv.appendChild(document.createTextNode(rowData[colName]));
                    
                    nav.appendChild(rowDiv);
                    colIndex++;
                }
                
                fragment.appendChild(nav);
                
                // Single DOM update
                const container = document.getElementById('rowDetailsContainer');
                container.innerHTML = '';
                container.appendChild(fragment);

                // Show the modal
                $('#infoModal').modal('show');
            }
            
            // Listen for custom event from bar_charts.html
            document.addEventListener('showStudyDetailsRequest', function(e) {
                const studyId = e.detail.studyId;
                showStudyDetails(studyId);
            });


            function applyFilters() {
                let filteredData = [];

                // Cache all column indices at the beginning
                const columnIndices = {};
                $('table thead th').each(function() {
                    const colName = $(this).data('col');
                    if (colName) {
                        columnIndices[colName] = $(this).index() + 1;
                    }
                });
                
                // Pre-compute filter states for all filter groups
                const filterStates = {};
                $('.filter-group').each(function() {
                    const $filterGroup = $(this);
                    const colName = $filterGroup.data('col');
                    
                    // Cache checkbox states
                    const $checkboxes = $filterGroup.find('input[type=checkbox]');
                    if ($checkboxes.length > 0) {
                        const checked = $checkboxes.filter(':checked');
                        const unchecked = $checkboxes.not(':checked');
                        
                        filterStates[colName] = {
                            hasCheckboxes: true,
                            hasCheckedBoxes: checked.length > 0,
                            values: checked.length > 0 ? checked.map(function() { return $(this).val(); }).get() : [],
                            uncheckedValues: unchecked.map(function() { return $(this).val(); }).get(),
                            isExclusive: exclusiveFiltering[colName] || false
                        };
                    }
                    
                    // Cache range filter states
                    const $rangeSlider = $filterGroup.find('.range-slider');
                    if ($rangeSlider.length > 0) {
                        const range = $rangeSlider[0].noUiSlider.get();
                        filterStates[colName] = {
                            hasRangeSlider: true,
                            minValue: parseInt(range[0]),
                            maxValue: parseInt(range[1])
                        };
                    }
                });
                
                // Cache DOM selections
                const $rows = $('tbody tr');
                const $tableHeaders = $('table thead th');
                const visibleRows = []; // Track rows to show
                
                // Process each row
                $rows.each(function() {
                    const row = $(this);
                    let showRow = true;
                    
                    // Cache cell values for this row
                    const cellValues = {};
                    
                    // Process each filter group
                    for (const colName in filterStates) {
                        if (!showRow) break; // Early termination if row is already hidden
                        
                        const colIndex = columnIndices[colName];
                        const filterState = filterStates[colName];
                        
                        // Process checkbox filters
                        if (filterState.hasCheckboxes) {
                            if (!filterState.hasCheckedBoxes) {
                                showRow = false;
                                continue;
                            }
                            
                            // Get cell text only when needed
                            if (!cellValues[colIndex]) {
                                const cellText = row.find(`td:nth-child(${colIndex})`).text().trim();
                                cellValues[colIndex] = cellText.split(',').map(val => val.trim());
                            }
                            
                            // Special handling for parenthetical columns
                            const isParentheticalColumn = parentheticalColumns.includes(colName);
                            
                            if (filterState.isExclusive) {
                                // Exclusive filtering logic
                                if (filterState.uncheckedValues.some(value => 
                                    cellValues[colIndex].some(cellValue => {
                                        if (isParentheticalColumn) {
                                            // Extract the base value before any parentheses
                                            const baseValue = cellValue.split('(')[0].trim();
                                            return baseValue === value;
                                        }
                                        return cellValue === value;
                                    }))) {
                                    showRow = false;
                                }
                            } else {
                                // Inclusive filtering logic
                                if (!cellValues[colIndex].some(cellValue => 
                                    filterState.values.some(value => {
                                        if (isParentheticalColumn) {
                                            // Extract the base value before any parentheses
                                            const baseValue = cellValue.split('(')[0].trim();
                                            return baseValue === value;
                                        }
                                        return cellValue === value;
                                    }))) {
                                    showRow = false;
                                }
                            }
                        }
                        
                        // Process range filters
                        if (filterState.hasRangeSlider && showRow) {
                            // Get cell value only when needed
                            if (!cellValues[colIndex + '_raw']) {
                                cellValues[colIndex + '_raw'] = parseInt(row.find(`td:nth-child(${colIndex})`).text());
                            }
                            
                            if (cellValues[colIndex + '_raw'] < filterState.minValue || 
                                cellValues[colIndex + '_raw'] > filterState.maxValue) {
                                showRow = false;
                            }
                        }
                    }
                    
                    // Collect rows to show/hide
                    if (showRow) {
                        // Create a fresh object for row data
                        const rowData = {};
                        row.find('td').each(function(index) {
                            const colName = $tableHeaders.eq(index).data('col');
                            if (colName) { // Add check to handle potential undefined values
                                rowData[colName] = $(this).text().trim();
                            }
                        });
                        filteredData.push(rowData);
                    }
                    
                    // Toggle visibility
                    row.toggle(showRow);
                });
                
                // Cache the checked columns selection
                const $checkedColumns = $('.column-toggle:checked');
                const selectedColumns = $checkedColumns.map(function() {
                    return $(this).closest('.form-check').find('label').text();
                }).get();

                // Generate bar charts with the filtered data
                generateBarCharts(filteredData, selectedColumns);

                // Filter similarity visualization if it exists
                if (window.filterSimilarityVisualization) {
                    window.filterSimilarityVisualization(filteredData);
                }
            }

            applyFilters(); // Apply filters on page load - Important - please keep!

            $('.filter-group input').on('change', function() {
                if (!isUpdatingCheckboxes) {
                    applyFilters();
                }
            });

                $('#downloadFilteredCsv, #downloadFilteredCsvChart').on('click', function () {
                    const filteredData = getFilteredData();
                    downloadCsv(filteredData, 'filtered_data.csv');
                });

                $('#downloadFullCsv, #downloadFullCsvChart').on('click', function () {
                    const fullData = getFullData();
                    downloadCsv(fullData, 'full_data.csv');
                });

            });

        function sortTable(header) {
            const table = header.closest("table");
            const tbody = table.querySelector("tbody");
            
            // Cache header position calculation
            const colIndex = Array.prototype.indexOf.call(header.parentElement.children, header);
            
            // Toggle order
            const ascending = header.dataset.order !== "asc";
            header.dataset.order = ascending ? "asc" : "desc";

            // Use document fragment for efficient DOM manipulation
            const fragment = document.createDocumentFragment();
            const rows = Array.from(tbody.querySelectorAll("tr"));
            
            // Detect if the column is numeric (one-time check outside the sort function)
            const isNumeric = rows.every(row => !isNaN(parseFloat(row.cells[colIndex].innerText)));
            
            // Sort all rows at once
            rows.sort((rowA, rowB) => {
                const cellA = rowA.cells[colIndex].innerText.trim();
                const cellB = rowB.cells[colIndex].innerText.trim();
                
                if (isNumeric) {
                    return ascending ? Number(cellA) - Number(cellB) : Number(cellB) - Number(cellA);
                } else {
                    return ascending ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
                }
            });
            
            // Append all rows to fragment first, then to DOM in a single operation
            rows.forEach(row => fragment.appendChild(row));
            tbody.appendChild(fragment);
        }

        function downloadCsv(data, filename) {
            const csvContent = data.map(e => e.join(",")).join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function getFilteredData() {
            // Cache DOM selections
            const $checkedColumns = $('.column-toggle:checked');
            const selectedColumns = $checkedColumns.map(function () {
                return $(this).data('index');
            }).get();

            const $tableHeaders = $('table thead th');
            const header = $tableHeaders.map(function (index) {
                if (selectedColumns.includes(index + 1)) {
                    return $(this).text().trim().replace(' ▲▼', '');
                }
            }).get();

            const filteredData = [header];
            const $visibleRows = $('tbody tr:visible');
            $visibleRows.each(function () {
                const row = [];
                $(this).find('td').each(function (index) {
                    if (selectedColumns.includes(index + 1)) {
                        row.push($(this).text().trim());
                    }
                });
                filteredData.push(row);
            });
            return filteredData;
        }

        function getFullData() {
            const header = $('table thead th').map(function (index) {
                if (index > 0) { // Skip the first column
                    return $(this).text().trim().replace(' ▲▼', '');
                }
            }).get();

            const fullData = [header];
            $('tbody tr').each(function () {
                const row = [];
                $(this).find('td').each(function (index) {
                    if (index > 0) { // Skip the first column
                        row.push($(this).text().trim());
                    }
                });
                fullData.push(row);
            });
            return fullData;
        }

        // Replace the current event handlers with these simpler ones
        $('#advancedFiltersCollapse').on('show.bs.collapse', function() {
            $('#advancedFiltersToggleBtn').text('Collapse');
        });

        $('#advancedFiltersCollapse').on('hide.bs.collapse', function() {
            $('#advancedFiltersToggleBtn').text('Show');
        });
    </script>
    <style>
        body {
            padding: 0px !important;
        }

        .container-fluid {
            display: flex;
            height: 100vh;
        }

        .table-container {
            flex: 2;
            overflow: auto;
        }

        .sidebar {
            flex: 0.8;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            max-height: 100vh;
            overflow-y: scroll;
        }

        .panel {
            background-color: #f8f9fa;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex: 1;
        }

        .navbar-item {
            padding: 20px;
        }

        .navbar-item:hover {
            background-color: rgba(184, 148, 145, 0.6); /* Use the same color with 60% opacity */
            color: white;
        }

        .navbar-item-selected {
            background-color: #B89491;
            font-weight: bold;
            color: white;
        }

        .slider-container {
            padding: 0 20px; /* Adjust the padding as needed */
            margin-top: 5px; /* Add extra space underneath the slider */
            margin-bottom: 30px; /* Add extra space underneath the slider */
        }

        .slider-container .noUi-tooltip {
            bottom: -25px; /* Adjust this value as needed to move the tooltip further down */
            padding: 0px 0px; /* Adjust the padding as needed */
        }

        .noUi-tooltip {
            background: none; /* Remove background */
            border: none; /* Remove border */
            box-shadow: none; /* Remove box shadow */
            color: inherit; /* Inherit text color */
            padding: 0; /* Remove padding */
            bottom: -5px; /* Adjust this value as needed to move the tooltip further down */
        }

        .centered-cell {
            text-align: center;
            vertical-align: middle;
        }

        .fixed-width {
            width: 25px; /* Adjust the width as needed */
        }

        .modal-body h5 {
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #B89491;
        }

        .modal-body .list-group-item {
            border: none;
            padding: 10px 15px;
            background-color: #f8f9fa;
            margin-bottom: 5px;
            border-radius: 5px;
        }

        /* Style checkboxes to match the grey color of the modal close button */
        input[type="checkbox"] {
            accent-color: #6c757d; /* Bootstrap's secondary color */
        }

        /* Style sliders to match the color #B89491 */
        .noUi-connect {
            background: #B89491; /* Connected range color */
        }

        /* Style the select all and deselect all buttons to match the grey color */
        .btn-primary, .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }

        .btn-primary:hover, .btn-secondary:hover {
            background-color: rgba(108, 117, 125, 0.6); /* Use the same color with 60% opacity */
            border-color: rgba(108, 117, 125, 0.6); /* Use the same color with 60% opacity */
        }

        /* Style the exclusive filtering button to match the color #B89491 */
        .btn-warning {
            background-color: #B89491;
            border-color: #B89491;
            color: white; /* Change font color to white */
        }

        .btn-warning:hover {
            background-color: rgba(184, 148, 145, 0.6); /* Use the same color with 60% opacity */
            border-color: rgba(184, 148, 145, 0.6); /* Use the same color with 60% opacity */
            color: white; /* Change font color to white */
        }

        .form-check-input:checked {
            background-color: #6c757d;
            border-color: #6c757d;
        }

        .form-check-input:hover {
            background-color: rgba(108, 117, 125, 0.6); /* Use the same color with 60% opacity */
            border-color: rgba(108, 117, 125, 0.6); /* Use the same color with 60% opacity */
        }

        .small-button {
            font-size: 0.75rem; /* Adjust the font size as needed */
            padding: 0.1rem 0.2rem; /* Adjust the padding as needed */
        }

        #advancedFiltersCollapse {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #dee2e6;
        }

    </style>
</head>

<body class="container-fluid">
    <div class="table-container p-3">
        <div class="d-flex w-100 flex-row align-items-center justify-content-between mb-5">
            <div class="d-flex flex-row">
            <div class="d-flex flex-row align-items-center">
                <img style="height: 40px" class="me-4"
                    src="https://open-earable.teco.edu/assets/images/OE_Logo_black_RGB.png">
                <div>
                    <h3 class=""><b>earXplore</b></h3>
                    Interaction
                </div>
            </div>
            <div class="ms-5 d-flex flex-row align-items-center">
                <div class="navbar-item navbar-item-selected" data-section="tableView">Tabular Overview</div>
                <div class="navbar-item ms-1" data-section="chartView">Distribution Charts</div>
                <div class="navbar-item ms-1" data-section="similarityView">Study Similarity</div>
                <div class="navbar-item ms-1" data-section="timeView">Study Timeline</div>
            </div>
        </div>
            <div ><b><a style="text-decoration: none; color: #B89491">Add your study <br/> Report Mistake</b></a></div>
        </div>

        <!-- Toggle Menu Select/Deselect All Buttons -->
        <div class="d-flex mb-2">
            <button type="button" class="btn btn-sm btn-primary me-2 small-button" id="toggleSelectAllColumns">Select All</button>
            <button type="button" class="btn btn-sm btn-secondary small-button" id="toggleDeselectAllColumns">Deselect All</button>
        </div>

        <div class="mb-5">
            <div id="columnToggles" class="d-flex flex-wrap gap-2" type="checkbox"></div>
        </div>
    
        <!-- Tabular Overview Section -->
        <div id="tableView" class="content-section">
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th data-col="INFO" class="fixed-width"></th> <!-- New column header with fixed width and transparency -->
                            {% for col in data[0].keys() %}
                            <th data-col="{{ col }}" onclick="sortTable(this)">{{ col.split('_')[-1] }} ▲▼</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in data %}
                        <tr>
                            <td class="centered-cell fixed-width"><i class="bi bi-info-circle" title="Info about this row"></i></td> <!-- New column with info icon, fixed width -->
                            {% for value in row.values() %}
                            <td>{{ value }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="d-flex mb-2">
                    <button type="button" class="btn btn-sm btn-warning me-2 small-button" id="downloadFilteredCsv">Download Selection as .csv</button>
                    <button type="button" class="btn btn-sm btn-warning small-button" id="downloadFullCsv">Download Full Dataset as .csv</button>
                </div>
            </div>
        </div>
    
        <!-- Distribution Charts Section -->
        <div id="chartView" class="content-section" style="display: none;">
            {% include 'bar_charts.html' %}
        </div>

        <div id="similarityView" class="content-section" style="display: none;">
            {% include 'similarity.html' %}
        </div>

        <div id="timeView" class="content-section" style="display: none;">
            {% include 'time.html' %}
        </div>
    </div>
    
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const navbarItems = document.querySelectorAll(".navbar-item");
        const sections = document.querySelectorAll(".content-section");

        navbarItems.forEach(item => {
            item.addEventListener("click", function() {
                // Remove selected class from all items
                navbarItems.forEach(nav => nav.classList.remove("navbar-item-selected"));
                // Add selected class to clicked item
                this.classList.add("navbar-item-selected");

                // Hide all sections
                sections.forEach(section => section.style.display = "none");
                // Show selected section
                const sectionId = this.getAttribute("data-section");
                document.getElementById(sectionId).style.display = "block";
                
                // If switching to similarity view, apply current filters
                if (sectionId === "similarityView" && window.filterSimilarityVisualization) {
                    // Get currently filtered data (visible rows)
                    const filteredData = [];
                    $('tbody tr:visible').each(function() {
                        const rowData = {};
                        $(this).find('td').each(function(index) {
                            const colName = $('table thead th').eq(index).data('col');
                            if (colName) {
                                rowData[colName] = $(this).text().trim();
                            }
                        });
                        filteredData.push(rowData);
                    });
                    
                    // Apply filters to similarity visualization
                    window.filterSimilarityVisualization(filteredData);
                }
            });
        });
    });
    </script>

    <div class="sidebar">
        {% set panels = {} %}
        {% for col in data[0].keys() %}
        {% set prefix = col.split('_')[0] if '_' in col else 'General Information' %}
        {% if prefix not in panels %}
        {% set _ = panels.update({prefix: []}) %}
        {% endif %}
        {% set _ = panels[prefix].append(col) %}
        {% endfor %}

        {% set excluded_filter_columns = ['ID','First Author', 'Gesture', 'Keywords', 'Abstract', 'Study Link'] %}
        
        {% for panel, columns in panels.items() %}
        <div class="panel">
            <div class="d-flex justify-content-between align-items-center">
                <h3>{{ panel.replace('_PANEL', '') }}</h3>
                
                {% if panel in ['Interaction', 'Implementation', 'Study'] %}
                <div class="button-container">
                    <button type="button" class="btn btn-sm btn-primary select-all-panel small-button" data-panel="{{ panel }}">Select All</button>
                    <button type="button" class="btn btn-sm btn-secondary deselect-all-panel ms-2 small-button" data-panel="{{ panel }}">Deselect All</button>
                </div>
                {% endif %}
            </div>
            <hr/>
            <div class="filters">
                
                {% set parenthetical_columns = [
                    'Interaction_PANEL_Accuracy of Interaction Recognition', 
                    'Interaction_PANEL_Robustness of Interaction Detection', 
                    'Study_PANEL_Elicitation Study', 
                    'Study_PANEL_Usability Evaluations', 
                    'Study_PANEL_Cognitive Ease Evaluations', 
                    'Study_PANEL_Discreetness of Interactions Evaluations', 
                    'Study_PANEL_Social Acceptability of Interactions Evaluations', 
                    'Study_PANEL_Accuracy of Interactions Evaluations', 
                    'Study_PANEL_Alternative Interaction Validity Evaluations'
                ] %}

                {% for col in columns if col not in excluded_filter_columns %}
                {% if col == 'Year' or col == 'Interaction_PANEL_Number of Selected Gestures' %}
                {% set min_value = data | map(attribute=col) | min %}
                {% set max_value = data | map(attribute=col) | max %}
                <div class="filter-group" data-col="{{ col }}">
                    <strong>{{ col.split('_')[-1] }}</strong>
                    {% if col in explanations %}
                    <span title="{{ explanations[col] }}" class="ms-1">
                        <i class="bi bi-question-circle-fill"></i>
                    </span>
                    {% endif %}
                    <br>
                    <div class="slider-container">
                        <div class="range-slider" data-col="{{ col }}" data-min="{{ min_value }}" data-max="{{ max_value }}"></div>
                    </div>
                </div>
                {% else %}
                {% set unique_values = [] %}
                {% for row in data %}
                    {% if row[col] is string %}
                        {% set cell_values = row[col].split(',') %}
                    {% else %}
                        {% set cell_values = [row[col]] %}
                    {% endif %}
                    {% for value in cell_values %}
                        {% if value is string %}
                            {% set trimmed_value = value.strip() %}
                            {% if col in parenthetical_columns %}
                                {% set base_value = trimmed_value.split('(')[0].strip() %}
                            {% else %}
                                {% set base_value = trimmed_value %}
                            {% endif %}
                        {% else %}
                            {% set base_value = value %}
                        {% endif %}
                        {% if base_value not in unique_values and base_value %}
                            {% set _ = unique_values.append(base_value) %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
                {% set sorted_values = unique_values | custom_sort %}
                <div class="filter-group mt-2" data-col="{{ col }}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ col.split('_')[-1] }}</strong>
                            {% if col in explanations %}
                            <span title="{{ explanations[col] }}" class="ms-1">
                                <i class="bi bi-question-circle-fill"></i>
                            </span>
                            {% endif %}
                        </div>
                        {% if panel in ['General Information', 'Sensing', 'Application'] and col != 'Sensing_PANEL_No Additional Sensing' %}
                        <div class="d-flex justify-content-end">
                            {% if col == 'Sensing_PANEL_Sensors' %}
                            <button type="button" class="btn btn-sm btn-warning exclusive-filter ms-2 small-button" data-col="{{ col }}">Exclusive Filtering (Deactivated)</button>
                            {% endif %}
                            <button type="button" class="btn btn-sm btn-primary select-all ms-2 small-button" data-col="{{ col }}">Select All</button>
                            <button type="button" class="btn btn-sm btn-secondary deselect-all ms-2 small-button" data-col="{{ col }}">Deselect All</button>
                        </div>
                        {% endif %}
                    </div>
                    <div class="d-flex flex-wrap flex-row">
                        {% for value in sorted_values %}
                        <label class="me-3 d-flex align-items-center">
                            <input class="me-1" type="checkbox" name="{{ col }}" value="{{ value }}"> {{ value }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        <!-- Advanced Filters Panel -->
        <div class="panel">
            <div class="d-flex justify-content-between align-items-center">
                <h3>Advanced Filters</h3>
                <button id="advancedFiltersToggleBtn" class="btn btn-sm btn-warning" type="button" data-bs-toggle="collapse" 
                data-bs-target="#advancedFiltersCollapse" aria-expanded="false" aria-controls="advancedFiltersCollapse">
                Show/Hide
            </button>
            </div>
            <hr/>
            
            <div class="collapse" id="advancedFiltersCollapse">
                <div class="filters">
                    {% set advanced_filter_columns = ['First Author', 'Gesture', 'Keywords'] %}
                    
                    {% for col in advanced_filter_columns %}
                        {% set unique_values = [] %}
                        {% for row in data %}
                            {% if row[col] is string %}
                                {% set cell_values = row[col].split(',') %}
                            {% else %}
                                {% set cell_values = [row[col]] %}
                            {% endif %}
                            {% for value in cell_values %}
                                {% if value is string %}
                                    {% set trimmed_value = value.strip() %}
                                    {% set base_value = trimmed_value %}
                                {% else %}
                                    {% set base_value = value %}
                                {% endif %}
                                {% if base_value not in unique_values and base_value %}
                                    {% set _ = unique_values.append(base_value) %}
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                        {% set sorted_values = unique_values | custom_sort %}
                        <div class="filter-group mt-2" data-col="{{ col }}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ col.split('_')[-1] }}</strong>
                                    {% if col in explanations %}
                                    <span title="{{ explanations[col] }}" class="ms-1">
                                        <i class="bi bi-question-circle-fill"></i>
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="d-flex justify-content-end">
                                    <button type="button" class="btn btn-sm btn-primary select-all ms-2 small-button" data-col="{{ col }}">Select All</button>
                                    <button type="button" class="btn btn-sm btn-secondary deselect-all ms-2 small-button" data-col="{{ col }}">Deselect All</button>
                                </div>
                            </div>
                            <div class="d-flex flex-wrap flex-row">
                                {% for value in sorted_values %}
                                <label class="me-3 d-flex align-items-center">
                                    <input class="me-1" type="checkbox" name="{{ col }}" value="{{ value }}" checked> {{ value }}
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
<!-- Modal Structure -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body">
                <div id="rowDetailsContainer">
                    <!-- Row details will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <a id="studyLinkButton" href="#" target="_blank" class="btn btn-warning">Open Online Source</a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
</body>

</html>
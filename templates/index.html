<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>earXplore - Earable Interaction Database</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/ui-range@1.1.2/dist/ui-range.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function () {
            // Show only first six columns initially
            $('table thead th:nth-child(n+7), table tbody td:nth-child(n+7)').hide();

            // Populate column toggle menu
            let columns = [];
            $('table thead th').each(function (index) {
                if (index > 0) { // Skip the first column
                    let colName = $(this).data('col').split('_').pop(); // Removes prefixes, keeping only the last part
                    columns.push(`<div class="form-check">
                                    <input class="form-check-input column-toggle" type="checkbox" data-index="${index + 1}" ${index < 6 ? 'checked' : ''}>
                                    <label class="form-check-label">${colName}</label>
                                </div>`);
                }
            });
            $('#columnToggles').html(columns.join(''));

            // Toggle column visibility
            $('.column-toggle').on('change', function () {
                let colIndex = $(this).data('index');
                let isChecked = $(this).is(':checked');
                $(`table thead th:nth-child(${colIndex}), table tbody td:nth-child(${colIndex})`).toggle(isChecked);
            });

            // Select All and Deselect All functionality
            $('.select-all').on('click', function () {
                let colName = $(this).data('col');
                $(`.filter-group[data-col="${colName}"] input[type=checkbox]`).prop('checked', true).trigger('change');
            });

            $('.deselect-all').on('click', function () {
                let colName = $(this).data('col');
                $(`.filter-group[data-col="${colName}"] input[type=checkbox]`).prop('checked', false).trigger('change');
            });

            // New functionality for panel-wide select/deselect
            $('.select-all-panel').on('click', function () {
                let panelName = $(this).data('panel');
                $(`.panel:has(h3:contains("${panelName}")) .filter-group input[type=checkbox]`).prop('checked', true).trigger('change');
            });

            $('.deselect-all-panel').on('click', function () {
                let panelName = $(this).data('panel');
                $(`.panel:has(h3:contains("${panelName}")) .filter-group input[type=checkbox]`).prop('checked', false).trigger('change');
            });

            // Initialize noUiSlider for range sliders
            $('.range-slider').each(function () {
                let slider = this;
                let min = parseInt($(slider).data('min'));
                let max = parseInt($(slider).data('max'));

                noUiSlider.create(slider, {
                    start: [min, max],
                    connect: true,
                    range: {
                        'min': min,
                        'max': max
                    },
                    tooltips: [true, true],
                    format: {
                        to: function (value) {
                            return Math.round(value);
                        },
                        from: function (value) {
                            return Number(value);
                        }
                    }
                });

                slider.noUiSlider.on('update', function (values, handle) {
                    let minValue = Math.round(values[0]);
                    let maxValue = Math.round(values[1]);
                    $(slider).closest('.filter-group').find('.range-min').text(minValue);
                    $(slider).closest('.filter-group').find('.range-max').text(maxValue);
                });

                slider.noUiSlider.on('change', applyFilters);
            });

            // Filtering logic
            $('.filter-group input[type=checkbox]').prop('checked', true);
            $('.filter-group input[type=range]').each(function () {
                $(this).val($(this).attr('max'));
            });

            // Exclusive Filtering state
            let exclusiveFiltering = {};

            // Toggle Exclusive Filtering
            $('.exclusive-filter').on('click', function () {
                let colName = $(this).data('col');
                exclusiveFiltering[colName] = !exclusiveFiltering[colName];
                $(this).text(`Exclusive Filtering (${exclusiveFiltering[colName] ? 'Activated' : 'Deactivated'})`);
                applyFilters();
            });

            // Add event listener to info icons
            $('table').on('click', '.bi-info-circle', function () {
                let row = $(this).closest('tr');
                let rowData = {};
                row.find('td').each(function (index) {
                    let colName = $('table thead th').eq(index).data('col');
                    rowData[colName] = $(this).text().trim();
                });

                // Populate the modal with row data
                let detailsHtml = '<nav>';
                delete rowData.INFO; // Remove the INFO column

                let colNames = Object.keys(rowData); // Skip the first column

                // Add headings and details
                detailsHtml += '<h5>General Information</h5>';
                for (let i = 0; i < colNames.length; i++) {
                    if (i === 5) {
                        detailsHtml += '<h5>Sensors</h5>';
                    } else if (i === 7) {
                        detailsHtml += '<h5>Interaction</h5>';
                    } else if (i === 15) {
                        detailsHtml += '<h5>Implementation</h5>';
                    } else if (i === 18) {
                        detailsHtml += '<h5>Study</h5>';
                    } else if (i === 27) {
                        detailsHtml += '<h5>Applications</h5>';
                    }
                    let colName = colNames[i];
                    let formattedColName = colName.split('_').pop(); // Format the column name
                    detailsHtml += `<div><strong>${formattedColName}:</strong> ${rowData[colName]}</div>`;
                }
                detailsHtml += '</nav>';
                $('#rowDetailsContainer').html(detailsHtml);

                // Show the modal
                $('#infoModal').modal('show');
            });


            let filteredData = [];

            function applyFilters() {
                filteredData = [];
                $('tbody tr').each(function () {
                    let row = $(this);
                    let showRow = true;

                    $('.filter-group').each(function () {
                        // Determine the target column for this filter group
                        let colName = $(this).data('col');
                        let colIndex = $('table thead th[data-col="' + colName + '"]').index() + 1;

                        // If there are checkboxes in this filter group:
                        if ($(this).find('input[type=checkbox]').length > 0) {
                            let checked = $(this).find('input[type=checkbox]:checked');
                            let unchecked = $(this).find('input[type=checkbox]:not(:checked)');
                            // If no checkbox is selected, then hide the row.
                            if (checked.length === 0) {
                                showRow = false;
                            } else {
                                let values = checked.map(function () {
                                    return $(this).val();
                                }).get();
                                let uncheckedValues = unchecked.map(function () {
                                    return $(this).val();
                                }).get();
                                // Get the text in the corresponding column cell.
                                let cellText = row.find('td:nth-child(' + colIndex + ')').text().trim();
                                // Split the cell text by commas and trim each value.
                                let cellValues = cellText.split(',').map(value => value.trim());

                                if (exclusiveFiltering[colName]) {
                                    // Exclusive filtering: none of the deselected values must be present
                                    if (uncheckedValues.some(value => cellValues.includes(value))) {
                                        showRow = false;
                                    }
                                } else {
                                    // Non-exclusive filtering: at least one selected value must be present
                                    if (!cellValues.some(value => values.includes(value))) {
                                        showRow = false;
                                    }
                                }
                            }
                        }

                        // If there's a range filter in this group:
                        if ($(this).find('.range-slider').length > 0) {
                            let range = $(this).find('.range-slider')[0].noUiSlider.get();
                            let minValue = parseInt(range[0]);
                            let maxValue = parseInt(range[1]);
                            // Get the number from the corresponding column cell.
                            let cellValue = parseInt(row.find('td:nth-child(' + colIndex + ')').text());
                            if (cellValue < minValue || cellValue > maxValue) {
                                showRow = false;
                            }
                        }
                    });
                    row.toggle(showRow);
                    if (showRow) {
                        const rowData = {};
                        row.find('td').each(function (index) {
                            const colName = $('table thead th').eq(index).data('col');
                            rowData[colName] = $(this).text().trim();
                        });
                        filteredData.push(rowData);
                    }
                });

                generateBarCharts(filteredData);
            }

            $('.filter-group input').on('change', applyFilters);
            });

        function sortTable(header) {
            let table = header.closest("table");
            let tbody = table.querySelector("tbody");
            let colIndex = Array.from(header.parentElement.children).indexOf(header);
            let rows = Array.from(tbody.querySelectorAll("tr"));
            let ascending = header.dataset.order !== "asc"; // Toggle order
            header.dataset.order = ascending ? "asc" : "desc";

            // Detect if the column is numeric
            let isNumeric = rows.every(row => !isNaN(parseFloat(row.cells[colIndex].innerText)));

            rows.sort((rowA, rowB) => {
                let cellA = rowA.cells[colIndex].innerText.trim();
                let cellB = rowB.cells[colIndex].innerText.trim();

                if (isNumeric) {
                    return ascending ? cellA - cellB : cellB - cellA;
                } else {
                    return ascending ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
                }
            });

            // Append sorted rows back
            rows.forEach(row => tbody.appendChild(row));
        }
    </script>
    <style>
        body {
            padding: 0px !important;
        }

        .container-fluid {
            display: flex;
            height: 100vh;
        }

        .table-container {
            flex: 2;
            overflow: auto;
        }

        .sidebar {
            flex: 0.8;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            max-height: 100vh;
            overflow-y: scroll;
        }

        .panel {
            background-color: #f8f9fa;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex: 1;
        }

        .navbar-item {
            padding: 20px;
        }

        .navbar-item:hover {
            background-color: rgba(184, 148, 145, 0.6); /* Use the same color with 60% opacity */
            color: white;
        }

        .navbar-item-selected {
            background-color: #B89491;
            font-weight: bold;
            color: white;
        }

        .slider-container {
            padding: 0 20px; /* Adjust the padding as needed */
            margin-top: 5px; /* Add extra space underneath the slider */
            margin-bottom: 30px; /* Add extra space underneath the slider */
        }

        .slider-container .noUi-tooltip {
            bottom: -25px; /* Adjust this value as needed to move the tooltip further down */
            padding: 0px 0px; /* Adjust the padding as needed */
        }

        .noUi-tooltip {
            background: none; /* Remove background */
            border: none; /* Remove border */
            box-shadow: none; /* Remove box shadow */
            color: inherit; /* Inherit text color */
            padding: 0; /* Remove padding */
            bottom: -5px; /* Adjust this value as needed to move the tooltip further down */
        }

        .centered-cell {
            text-align: center;
            vertical-align: middle;
        }

        .fixed-width {
            width: 25px; /* Adjust the width as needed */
        }

        .modal-body h5 {
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #B89491;
        }

        .modal-body .list-group-item {
            border: none;
            padding: 10px 15px;
            background-color: #f8f9fa;
            margin-bottom: 5px;
            border-radius: 5px;
        }

        /* Style checkboxes to match the grey color of the modal close button */
        input[type="checkbox"] {
            accent-color: #6c757d; /* Bootstrap's secondary color */
        }

        /* Style sliders to match the color #B89491 */
        .noUi-connect {
            background: #B89491; /* Connected range color */
        }

        /* Style the select all and deselect all buttons to match the grey color */
        .btn-primary, .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }

        .btn-primary:hover, .btn-secondary:hover {
            background-color: rgba(108, 117, 125, 0.6); /* Use the same color with 60% opacity */
            border-color: rgba(108, 117, 125, 0.6); /* Use the same color with 60% opacity */
        }

        /* Style the exclusive filtering button to match the color #B89491 */
        .btn-warning {
            background-color: #B89491;
            border-color: #B89491;
            color: white; /* Change font color to white */
        }

        .btn-warning:hover {
            background-color: rgba(184, 148, 145, 0.6); /* Use the same color with 60% opacity */
            border-color: rgba(184, 148, 145, 0.6); /* Use the same color with 60% opacity */
            color: white; /* Change font color to white */
        }

        .form-check-input:checked {
            background-color: #6c757d;
            border-color: #6c757d;
        }

        .form-check-input:hover {
            background-color: rgba(108, 117, 125, 0.6); /* Use the same color with 60% opacity */
            border-color: rgba(108, 117, 125, 0.6); /* Use the same color with 60% opacity */
        }

    </style>
</head>

<body class="container-fluid">
    <div class="table-container p-3">
        <div class="d-flex w-100 flex-row align-items-center justify-content-between mb-5">
            <div class="d-flex flex-row">
            <div class="d-flex flex-row align-items-center">
                <img style="height: 40px" class="me-4"
                    src="https://open-earable.teco.edu/assets/images/OE_Logo_black_RGB.png">
                <div>
                    <h3 class=""><b>earXplore</b></h3>
                    Interaction
                </div>
            </div>
            <div class="ms-5 d-flex flex-row align-items-center">
                <div class="navbar-item navbar-item-selected" data-section="tableView">Tabular Overview</div>
                <div class="navbar-item ms-1" data-section="chartView">Distribution Charts</div>
                <div class="navbar-item ms-1" data-section="similarityView">Study Similarity</div>
                <div class="navbar-item ms-1" data-section="timeView">Study Timeline</div>
            </div>
        </div>
            <div ><b><a style="text-decoration: none; color: #B89491" href="https://github.com/OpenEarable/earXplore">Add your study?</b> <i class="bi bi-github font-large"></i></a></div>
        </div>
    
        <!-- Tabular Overview Section -->
        <div id="tableView" class="content-section">
            <div class="mb-5">
                <div id="columnToggles" class="d-flex flex-wrap gap-2" type="checkbox"></div>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th data-col="INFO" class="fixed-width"></th> <!-- New column header with fixed width and transparency -->
                            {% for col in data[0].keys() %}
                            <th data-col="{{ col }}" onclick="sortTable(this)">{{ col.split('_')[-1] }} ▲▼</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in data %}
                        <tr>
                            <td class="centered-cell fixed-width"><i class="bi bi-info-circle" title="Info about this row"></i></td> <!-- New column with info icon, fixed width -->
                            {% for value in row.values() %}
                            <td>{{ value }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    
        <!-- Distribution Charts Section -->
        <div id="chartView" class="content-section" style="display: none;">
            {% include 'bar_charts.html' %}
        </div>

        <div id="similarityView" class="content-section" style="display: none;">
            {% include 'similarity.html' %}
        </div>

        <div id="timeView" class="content-section" style="display: none;">
            {% include 'time.html' %}
        </div>
    </div>
    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const navbarItems = document.querySelectorAll(".navbar-item");
            const sections = document.querySelectorAll(".content-section");
    
            navbarItems.forEach(item => {
                item.addEventListener("click", function() {
                    // Remove selected class from all items
                    navbarItems.forEach(nav => nav.classList.remove("navbar-item-selected"));
                    // Add selected class to clicked item
                    this.classList.add("navbar-item-selected");
    
                    // Hide all sections
                    sections.forEach(section => section.style.display = "none");
                    // Show selected section
                    const sectionId = this.getAttribute("data-section");
                    document.getElementById(sectionId).style.display = "block";
                });
            });
        });
    </script>

    <div class="sidebar">
        {% set panels = {} %}
        {% for col in data[0].keys() %}
        {% set prefix = col.split('_')[0] if '_' in col else 'General Information' %}
        {% if prefix not in panels %}
        {% set _ = panels.update({prefix: []}) %}
        {% endif %}
        {% set _ = panels[prefix].append(col) %}
        {% endfor %}

        {% for panel, columns in panels.items() %}
        <div class="panel">
            <div class="d-flex justify-content-between align-items-center">
                <h3>{{ panel.replace('_PANEL', '') }}</h3>
                {% if panel in ['Interaction', 'Implementation', 'Study'] %}
                <div class="button-container">
                    <button type="button" class="btn btn-sm btn-primary select-all-panel" data-panel="{{ panel }}">Select All</button>
                    <button type="button" class="btn btn-sm btn-secondary deselect-all-panel ms-2" data-panel="{{ panel }}">Deselect All</button>
                </div>
                {% endif %}
            </div>
            <div class="filters">
                {% for col in columns if col != 'Author' %}
                {% if col == 'Year' or col == 'Interaction_PANEL_Number of Selected Gestures' %}
                {% set min_value = data | map(attribute=col) | min %}
                {% set max_value = data | map(attribute=col) | max %}
                <div class="filter-group" data-col="{{ col }}">
                    <strong>{{ col.split('_')[-1] }}</strong>
                    {% if col in explanations %}
                    <span title="{{ explanations[col] }}" class="ms-1">
                        <i class="bi bi-question-circle-fill"></i>
                    </span>
                    {% endif %}
                    <br>
                    <div class="slider-container">
                        <div class="range-slider" data-col="{{ col }}" data-min="{{ min_value }}" data-max="{{ max_value }}"></div>
                    </div>
                </div>
                {% else %}
                {% set unique_values = [] %}
                {% for row in data %}
                {% set cell_values = row[col].split(',') %}
                {% for value in cell_values %}
                {% set trimmed_value = value.strip() %}
                {% if trimmed_value not in unique_values %}
                {% set _ = unique_values.append(trimmed_value) %}
                {% endif %}
                {% endfor %}
                {% endfor %}
                {% set sorted_values = unique_values | custom_sort %}
                <div class="filter-group mt-2" data-col="{{ col }}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ col.split('_')[-1] }}</strong>
                            {% if col in explanations %}
                            <span title="{{ explanations[col] }}" class="ms-1">
                                <i class="bi bi-question-circle-fill"></i>
                            </span>
                            {% endif %}
                        </div>
                        {% if panel in ['General Information', 'Sensing', 'Application'] and col != 'Sensing_PANEL_No Additional Sensing' %}
                        <div class="d-flex justify-content-end">
                            {% if col == 'Sensing_PANEL_Sensors' %}
                            <button type="button" class="btn btn-sm btn-warning exclusive-filter ms-2" data-col="{{ col }}">Exclusive Filtering (Deactivated)</button>
                            {% endif %}
                            <button type="button" class="btn btn-sm btn-primary select-all ms-2" data-col="{{ col }}">Select All</button>
                            <button type="button" class="btn btn-sm btn-secondary deselect-all ms-2" data-col="{{ col }}">Deselect All</button>
                        </div>
                        {% endif %}
                    </div>
                    <div class="d-flex flex-wrap flex-row">
                        {% for value in sorted_values %}
                        <label class="me-3 d-flex align-items-center">
                            <input class="me-1" type="checkbox" name="{{ col }}" value="{{ value }}"> {{ value }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
<!-- Modal Structure -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body">
                <div id="rowDetailsContainer">
                    <!-- Row details will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
</body>

</html>
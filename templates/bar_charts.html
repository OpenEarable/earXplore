<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Include Bootstrap CSS and JS for the modal -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
    /* Grid layout for charts */
    #chartsContainer {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Responsive grid */
        gap: 20px;
        padding: 20px;
    }

    .chart-wrapper {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        min-height: 300px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .chart-title {
        font-size: 16px;
        text-align: center;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .chart-title i {
        font-size: 14px;
        color: #6c757d;
        cursor: pointer;
    }

    .chart-wrapper canvas {
        width: 100% !important;
        height: 250px !important;
    }
</style>

<div id="chartsContainer"></div>

<!-- Modal Structure -->
<div class="modal fade" id="infoModalBarCharts" tabindex="-1" aria-labelledby="infoModalLabelBarCharts" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body">
                <div id="rowDetailsContainerBarCharts">
                    <!-- Row details will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    function generateBarCharts(filteredData) {
        const columns = {{ data[0].keys() | list | tojson }};
        const tableData = filteredData || {{ data | tojson }};
        const explanations = {{ explanations | tojson }}; // Explanation mapping

        const container = document.getElementById('chartsContainer');
        container.innerHTML = ""; // Clear previous charts

        // Define a custom color palette
        const colorPalette = ['#d1615d', '#5778a4', '#6a9f58', '#e49444', '#85b6b2', '#e7ca60', '#a87c9f', '#f1a2a9', '#967662', '#b8b0ac'];

        columns.forEach((col, colIndex) => {
            if (col === 'Author') return; // Skip Author column
            
            const uniqueGroups = {};
            tableData.forEach(row => {
                const cellText = row[col] || "Unknown";
                const cellValues = cellText.split(',').map(value => value.trim()); // Split the cell text by commas and trim each value
                cellValues.forEach(value => {
                    if (!uniqueGroups[value]) {
                        uniqueGroups[value] = [];
                    }
                    uniqueGroups[value].push(row);
                });
            });

            // Get explanation for this column (if available)
            const explanation = explanations[col] || '';

            // Create chart container
            const chartContainer = document.createElement('div');
            chartContainer.classList.add("chart-wrapper");
            chartContainer.innerHTML = `
                <h4 class="chart-title">
                    ${col.split('_').pop()}
                    ${explanation ? `<i class="bi bi-question-circle-fill" title="${explanation}"></i>` : ''}
                </h4>
                <canvas id="chart-${colIndex}"></canvas>
            `;
            container.appendChild(chartContainer);

            // Prepare data for the chart
            const labels = Object.keys(uniqueGroups);
            const dataValues = labels.map(label => uniqueGroups[label].length);

            // Calculate dynamic bar thickness
            const maxBarThickness = 30;
            const minBarThickness = 5;
            const barThickness = Math.max(minBarThickness, Math.min(maxBarThickness, 250 / labels.length));

            // Render Chart.js bar chart (Side-by-Side)
            new Chart(document.getElementById(`chart-${colIndex}`).getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,  // Labels for each unique group
                    datasets: [{
                        label: 'Number of Studies',
                        data: dataValues,
                        backgroundColor: labels.map((_, index) => colorPalette[index % colorPalette.length]),
                        barThickness: barThickness
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    const label = labels[tooltipItem.dataIndex];
                                    return `${tooltipItem.raw} studies. Click for list!`;
                                }
                            }
                        },
                        legend: {
                            display: false // Hide the legend
                        }
                    },
                    scales: {
                        x: {
                            stacked: false,
                            ticks: {
                                autoSkip: false,
                                callback: function(value, index, values) {
                                    const label = this.getLabelForValue(value);
                                    return label.length > 15 ? label.substr(0, 15) + '...' : label;
                                }
                            }
                        },
                        y: { 
                            stacked: false, 
                            beginAtZero: true, 
                            ticks: { stepSize: 1 }
                        }
                    },
                    onClick: (evt, activeElements) => {
                        if (activeElements.length > 0) {
                            const datasetIndex = activeElements[0].index;
                            const label = labels[datasetIndex];
                            const studies = uniqueGroups[label].map(row => `${row["Author"]}., (${row["Year"]})`).join("<br>");
                            document.getElementById('rowDetailsContainerBarCharts').innerHTML = studies;
                            const infoModal = new bootstrap.Modal(document.getElementById('infoModalBarCharts'));
                            infoModal.show();
                        }
                    }
                }
            });
        });
    }

    document.addEventListener("DOMContentLoaded", () => generateBarCharts());
</script>
</script>

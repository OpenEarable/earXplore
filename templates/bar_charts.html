<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* Grid layout for charts */
    #chartsContainer {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Responsive grid */
        gap: 20px;
        padding: 20px;
    }

    .chart-wrapper {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        min-height: 300px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .chart-title {
        font-size: 16px;
        text-align: center;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .chart-title i {
        font-size: 14px;
        color: #6c757d;
        cursor: pointer;
    }

    .chart-wrapper canvas {
        width: 100% !important;
        height: 250px !important;
    }
</style>

<div id="chartsContainer"></div>

<script>
    function generateBarCharts() {
        const columns = {{ data[0].keys() | list | tojson }};
        const tableData = {{ data | tojson }};
        const explanations = {{ explanations | tojson }}; // Explanation mapping

        const container = document.getElementById('chartsContainer');
        container.innerHTML = ""; // Clear previous charts

        columns.forEach((col, colIndex) => {
            if (col === 'Author') return; // Skip Author column
            
            const uniqueGroups = {};
            tableData.forEach(row => {
                const value = row[col] || "Unknown";
                if (!uniqueGroups[value]) {
                    uniqueGroups[value] = [];
                }
                uniqueGroups[value].push(row);
            });

            // Get explanation for this column (if available)
            const explanation = explanations[col] || '';

            // Create chart container
            const chartContainer = document.createElement('div');
            chartContainer.classList.add("chart-wrapper");
            chartContainer.innerHTML = `
                <h4 class="chart-title">
                    ${col.split('_').pop()}
                    ${explanation ? `<i class="bi bi-question-circle-fill" title="${explanation}"></i>` : ''}
                </h4>
                <canvas id="chart-${colIndex}"></canvas>
            `;
            container.appendChild(chartContainer);

            // Prepare data for the chart
            const labels = Object.keys(uniqueGroups);
            const dataValues = labels.map(label => uniqueGroups[label].length);

            // Render Chart.js bar chart (Side-by-Side)
            new Chart(document.getElementById(`chart-${colIndex}`).getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,  // Labels for each unique group
                    datasets: [{
                        label: 'Number of Studies',
                        data: dataValues,
                        backgroundColor: labels.map((_, index) => `hsl(${index * 45 % 360}, 70%, 60%)`),
                        barThickness: 30
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    const label = labels[tooltipItem.dataIndex];
                                    const studies = uniqueGroups[label].map(row => row["Author"]).join(", ");
                                    return `${label}: ${tooltipItem.raw} studies (${studies})`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { stacked: false, ticks: { autoSkip: false } },
                        y: { stacked: false, beginAtZero: true }
                    },
                    onClick: (evt, activeElements) => {
                        if (activeElements.length > 0) {
                            const datasetIndex = activeElements[0].index;
                            const label = labels[datasetIndex];
                        }
                    }
                }
            });
        });
    }

    document.addEventListener("DOMContentLoaded", generateBarCharts);
</script>

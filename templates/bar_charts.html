<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* Grid layout for charts */
    #chartsContainer {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); /* Responsive grid */
        gap: 20px;
        padding: 20px;
    }

    .chart-wrapper {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        min-height: 300px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .chart-title {
        font-size: 16px;
        text-align: center;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .chart-title i {
        font-size: 14px;
        color: #6c757d;
        cursor: pointer;
    }

    .chart-wrapper canvas {
        width: 100% !important;
        height: 250px !important;
    }
</style>

<div id="chartsContainer"></div>

<!-- Modal Structure -->
<div class="modal fade" id="infoModalBarCharts" tabindex="-1" aria-labelledby="infoModalLabelBarCharts" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body">
                <div id="rowDetailsContainerBarCharts">
                    <!-- Row details will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>

    const specialOrdersBarChart = {'Yes': 1, 'Partly': 2, 'No': 3, 'Low': 1, 'Medium': 2, 'High': 3, 'Semantic': 1, 'Coarse': 2, 'Fine': 3};

    function customSortBarChart(a, b) {
        const orderA = specialOrdersBarChart[a];
        const orderB = specialOrdersBarChart[b];

        if (orderA !== undefined && orderB !== undefined) {
            return orderA - orderB; // Both are special cases, sort by their order in the dictionary
        } else if (orderA !== undefined) {
            return -1; // a is a special case, it should come first
        } else if (orderB !== undefined) {
            return 1; // b is a special case, it should come first
        } else {
            const numA = parseFloat(a);
            const numB = parseFloat(b);
            if (!isNaN(numA) && !isNaN(numB)) {
                return numA - numB; // Both are numbers, sort numerically
            } else {
                return a.localeCompare(b); // Default alphabetical sorting
            }
        }
    }
        
    function generateBarCharts(filteredData, selectedColumns) {
        // Initialize chart tracking as an object keyed by column name
        if (!window.chartInstances) {
            window.chartInstances = {};
        }
        
        // Keep track of which columns are still active
        const activeColumns = new Set();

        const columns = {{ data[0].keys() | list | tojson }};
        const tableData = filteredData || {{ data | tojson }};
        const explanations = {{ explanations | tojson }}; // Explanation mapping

        const container = document.getElementById('chartsContainer');
        // Don't clear container - we'll update existing charts instead
        
        // Define a custom color palette
        const colorPalette = ['#d1615d', '#5778a4', '#6a9f58', '#e49444', '#85b6b2', '#e7ca60', '#a87c9f', '#f1a2a9', '#967662', '#b8b0ac'];

        columns.forEach((col, colIndex) => {
            if (col === 'Author' || !selectedColumns.includes(col.split('_').pop())) {
                // Skip this column
                return;
            }
            
            // Mark this column as active
            activeColumns.add(col);
            
            // Process data for this column
            const uniqueGroups = {};
            tableData.forEach(row => {
                const cellText = row[col] || "Unknown";
                const cellValues = cellText.split(',').map(value => value.trim());
                cellValues.forEach(value => {
                    if (!uniqueGroups[value]) {
                        uniqueGroups[value] = [];
                    }
                    uniqueGroups[value].push(row);
                });
            });
            
            // Prepare data for the chart
            const labels = Object.keys(uniqueGroups);
            labels.sort(customSortBarChart); // Use custom sort function
            const dataValues = labels.map(label => uniqueGroups[label].length);

            // Calculate dynamic bar thickness
            const maxBarThickness = 30;
            const minBarThickness = 5;
            const barThickness = Math.max(minBarThickness, Math.min(maxBarThickness, 250 / labels.length));
            
            // Check if we already have a chart for this column
            if (window.chartInstances[col]) {
                // Update existing chart
                const chart = window.chartInstances[col].chart;
                
                // Update chart data
                chart.data.labels = labels;
                chart.data.datasets[0].data = dataValues;
                chart.data.datasets[0].backgroundColor = labels.map((_, index) => 
                    colorPalette[index % colorPalette.length]);
                chart.data.datasets[0].barThickness = barThickness;
                
                // Store updated data for click handler
                window.chartInstances[col].labels = labels;
                window.chartInstances[col].uniqueGroups = uniqueGroups;
                
                // Apply changes
                chart.update();
            } else {
                // Create new chart container with column-based ID
                const chartId = `chart-${col.replace(/\s+/g, '-')}`;
                const chartContainer = document.createElement('div');
                chartContainer.id = `chart-container-${col.replace(/\s+/g, '-')}`;
                chartContainer.classList.add("chart-wrapper");
                
                // Add explanation if available
                const explanation = explanations[col] || '';
                chartContainer.innerHTML = `
                    <h4 class="chart-title">
                        ${col.split('_').pop()}
                        ${explanation ? `<i class="bi bi-question-circle-fill" title="${explanation}"></i>` : ''}
                    </h4>
                    <canvas id="${chartId}"></canvas>
                `;
                container.appendChild(chartContainer);

                // Create new chart
                const chart = new Chart(document.getElementById(chartId).getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Number of Studies',
                            data: dataValues,
                            backgroundColor: labels.map((_, index) => colorPalette[index % colorPalette.length]),
                            barThickness: barThickness
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(tooltipItem) {
                                        return `${tooltipItem.raw} studies. Click for list!`;
                                    }
                                }
                            },
                            legend: {
                                display: false // Hide the legend
                            }
                        },
                        scales: {
                            x: {
                                stacked: false,
                                ticks: {
                                    autoSkip: false,
                                    callback: function(value, index, values) {
                                        const label = this.getLabelForValue(value);
                                        return label.length > 15 ? label.substr(0, 15) + '...' : label;
                                    }
                                }
                            },
                            y: { 
                                stacked: false, 
                                beginAtZero: true, 
                                ticks: { stepSize: 1 }
                            }
                        },
                        onClick: (evt, activeElements) => {
                            if (activeElements.length > 0) {
                                const datasetIndex = activeElements[0].index;
                                const chartInfo = window.chartInstances[col];
                                const label = chartInfo.labels[datasetIndex];
                                const studies = `<h5>${col.split('_').pop()}: ${label}</h5>` + 
                                    chartInfo.uniqueGroups[label]
                                    .sort((a, b) => a["Author"].localeCompare(b["Author"]))
                                    .map(row => `${row["Author"]}., (${row["Year"]})`)
                                    .join("<br>");
                                document.getElementById('rowDetailsContainerBarCharts').innerHTML = studies;
                                const infoModal = new bootstrap.Modal(document.getElementById('infoModalBarCharts'));
                                infoModal.show();
                            }
                        }
                    }
                });
                
                // Add the chart instance to our tracking object
                window.chartInstances[col] = {
                    chart: chart,
                    labels: labels,
                    uniqueGroups: uniqueGroups
                };
            }
        });
        
        // Clean up charts for columns that are no longer active
        Object.keys(window.chartInstances).forEach(col => {
            if (!activeColumns.has(col)) {
                // Remove this chart
                window.chartInstances[col].chart.destroy();
                const containerId = `chart-container-${col.replace(/\s+/g, '-')}`;
                const container = document.getElementById(containerId);
                if (container) {
                    container.remove();
                }
                delete window.chartInstances[col];
            }
        });
    }
</script>

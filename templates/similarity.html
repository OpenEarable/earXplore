<!-- Include Cytoscape.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.21.0/cytoscape.min.js"></script>

<style>
    #networkGraph {
        width: 100%;
        height: 800px;
        border: 1px solid #ddd;
    }

    .controls {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 10px;
    }

    .tooltip {
        position: absolute;
        background-color: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 5px;
        border-radius: 5px;
        font-size: 12px;
        display: none;
        z-index: 10;
    }
</style>

<!-- Similarity slider -->
<div class="controls">
    <label>Similarity Threshold:</label>
    <input type="range" id="similaritySlider" min="0" max="100" step="5" value="50">
    <span id="similarityValue">50%</span>
</div>

<!-- Graph Container -->
<div id="networkGraph"></div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const rawData = {{ data | tojson }};
        const totalAttributes = Object.keys(rawData[0]).length - 1; // Exclude "Author"
        const colorPalette = ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"];
        let similarityThreshold = 50; // Default similarity threshold

        function calculateSimilarity(study1, study2) {
            let matchingAttributes = 0;

            for (let key in study1) {
                if (key !== "Author" && study1[key] === study2[key]) {
                    matchingAttributes++;
                }
            }

            return (matchingAttributes / totalAttributes) * 100;
        }

        function generateGraph() {
            const nodes = rawData.map((study, index) => ({
                data: {
                    id: index.toString(),
                    label: study["Author"] + " (" + study["Year"] + ")",
                    cluster: -1 // Placeholder for clustering
                }
            }));

            const edges = [];
            for (let i = 0; i < nodes.length; i++) {
                for (let j = i + 1; j < nodes.length; j++) {
                    let similarity = calculateSimilarity(rawData[i], rawData[j]);
                    if (similarity >= similarityThreshold) {
                        edges.push({
                            data: { source: nodes[i].data.id, target: nodes[j].data.id }
                        });
                    }
                }
            }

            // Assign clusters
            let clusterId = 0;
            const visited = new Set();
            function dfs(nodeId, cluster) {
                if (visited.has(nodeId)) return;
                visited.add(nodeId);
                nodes[nodeId].data.cluster = cluster;
                edges.forEach(edge => {
                    if (edge.data.source === nodeId.toString()) dfs(parseInt(edge.data.target), cluster);
                    if (edge.data.target === nodeId.toString()) dfs(parseInt(edge.data.source), cluster);
                });
            }

            for (let i = 0; i < nodes.length; i++) {
                if (!visited.has(i)) {
                    dfs(i, clusterId);
                    clusterId++;
                }
            }

            // Initialize Cytoscape.js
            const cy = cytoscape({
                container: document.getElementById("networkGraph"),
                elements: { nodes, edges },
                layout: { name: 'cose', animate: true },
                style: [
                    {
                        selector: "node",
                        style: {
                            "background-color": (ele) => colorPalette[ele.data("cluster") % colorPalette.length],
                            "label": "data(label)",
                            "text-valign": "center",
                            "text-halign": "center",
                            "color": "#fff",
                            "font-size": "10px",
                            "width": "10px",
                            "height": "10px"
                        }
                    },
                    {
                        selector: "edge",
                        style: {
                            "width": 1,
                            "line-color": "#aaa",
                            "curve-style": "haystack"
                        }
                    }
                ]
            });

            // Node click interaction
            cy.on("tap", "node", function (evt) {
                const nodeData = evt.target.data();
                alert(`Study: ${nodeData.label}`);
            });
        }

        // Initialize graph
        generateGraph();

        // Update graph on slider change
        document.getElementById("similaritySlider").addEventListener("input", function () {
            similarityThreshold = parseInt(this.value);
            document.getElementById("similarityValue").textContent = similarityThreshold + "%";
            generateGraph();
        });
    });
</script>
